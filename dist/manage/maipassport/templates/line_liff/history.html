{% extends 'line_liff/base.html' %}
{% load static %}
{% load i18n %}
{% load utils %}
{% block content %}
    <div class="container">
        <div class="card shadow mt-4 h-200 overflow-hidden">
            <div class="card-body">
                <h5 class="mb-0 font-weight-normal">{% trans 'Temperature record' %}</h5>
                <p class="text-mute text-secondary">{% trans 'Information from seven days' %}</p>

            </div>
            <div class="h-200 top-10">
                <canvas id="linechart"></canvas>
            </div>
        </div>
    </div>
    <div class="container top-30">
        <div class="card mb-4 shadow">
            <div class="card-body bg-none py-3">
                <div class="row">
                    <div class="col text-right">
                        <p>
                            {% if min_temp %}
                                {{ min_temp }}<i class="material-icons text-danger vm small">arrow_downward</i>
                            {% else %}
                                {% trans 'No record' %}
                            {% endif %}
                            <br><small class="text-mute">{% trans 'Lowest' %}</small>
                        </p>
                    </div>
                    <div class="col border-left-dotted">
                        <p>
                            {% if max_temp %}
                                <i class="material-icons text-success vm small mr-1">arrow_upward</i>{{ max_temp }}
                            {% else %}
                                {% trans 'No record' %}
                            {% endif %}
                            <br><small class="text-mute">{% trans 'Highest' %}</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="wrapper">
        <div class="container">
            <div class="row" style="padding-left: 14px;">

                <div class="col-12" style="padding-left: 0;padding-right: 0;">
                    <div class="card shadow-sm border-0 mb-3 wizard">
                        <div class="card-header p-0">
                            <ul class="nav nav-tabs tabs-md nav-justified" role="tablist">
                                <li role="presentation" class="nav-item">
                                    <a href="#step13" class="nav-link border-primary active" data-toggle="tab" aria-controls="step13" role="tab" title="Step 1">
                                        <i class="material-icons">transfer_within_a_station</i>
                                    </a>
                                </li>
                                <li role="presentation" class="nav-item">
                                    <a href="#step23" class="nav-link border-primary" data-toggle="tab" aria-controls="step23" role="tab" title="Step 2">
                                        <i class="material-icons">my_location</i>
                                    </a>
                                </li>
                                {% if not request.session.iii_login %}
                                <li role="presentation" class="nav-item">
                                    <a href="#step33" class="nav-link border-primary" data-toggle="tab" aria-controls="step33" role="tab" title="Step 3">
{#                                        <i class="material-icons">person_pin_circle</i>#}
                                        <i class="material-icons">local_offer</i>
                                    </a>
                                </li>
                                {% endif %}
                                <li role="presentation" class="nav-item">
                                    <a href="#step43" class="nav-link border-primary" data-toggle="tab" aria-controls="step43" role="tab" title="Step 4">
                                        <i class="material-icons">assignment</i>
                                    </a>
                                </li>
                            </ul>
                        </div>
{#                        <a onclick="approach_record()"></a>#}
                        <div class="card-body">
                            <div class="tab-content">
                                <div class="tab-pane active" role="tabpanel" id="step13">
                                    <h6 class="subtitle" style="padding-left: 15px;">{% trans 'Approach Record' %}</h6>
                                    <div class="col-12 px-0">
                                        <ul class="list-group list-group-flush border-top border-bottom" id="step1_div">
                                        </ul>
                                        <div style="height: 30px;"></div>
                                        <div id="step1_a_div" class="text-center"></div>
                                    </div>
                                </div>
                                <div class="tab-pane" role="tabpanel" id="step23">
                                    <h6 class="subtitle" style="padding-left: 15px;">{% trans 'Place Entry Record' %}</h6>
                                    <div class="col-12 px-0">
                                        <ul class="list-group list-group-flush border-top border-bottom" id="step2_div">
                                        </ul>
                                        <div style="height: 30px;"></div>
                                        <div id="step2_a_div" class="text-center"></div>
                                    </div>
                                </div>
                                {% if not request.session.iii_login %}
                                <div class="tab-pane" role="tabpanel" id="step33">
                                    <h6 class="subtitle" style="padding-left: 15px;">{% trans 'Clock In Record' %}</h6>
                                    <div class="col-12 px-0">
                                        <ul class="list-group list-group-flush border-top border-bottom" id="step3_div">
{#                                            <li class="list-group-item">#}
{#                                                <div class="row align-items-center">#}
{#                                                    <div class="col align-self-center pr-0">#}
{#                                                        <h6 class="font-weight-normal mb-1">公司</h6>#}
{#                                                        <p class="text-mute small text-secondary">2020-3-23 9:45</p>#}
{#                                                    </div>#}
{#                                                    <div class="col-auto">#}
{#                                                        <h6 class="text-success">上班</h6>#}
{#                                                    </div>#}
{#                                                </div>#}
{#                                            </li>#}
{#                                            <li class="list-group-item">#}
{#                                                <div class="row align-items-center">#}
{#                                                    <div class="col align-self-center pr-0">#}
{#                                                        <h6 class="font-weight-normal mb-1">公司</h6>#}
{#                                                        <p class="text-mute small text-secondary">2020-3-23 9:45</p>#}
{#                                                    </div>#}
{#                                                    <div class="col-auto">#}
{#                                                        <h6 class="text-danger">下班</h6>#}
{#                                                    </div>#}
{#                                                </div>#}
{#                                            </li>#}
                                        </ul>
                                        <div style="height: 30px;"></div>
                                        <div id="step3_a_div" class="text-center"></div>
                                    </div>
                                </div>
                                {% endif %}
                                <div class="tab-pane" role="tabpanel" id="step43">
                                    <h6 class="subtitle" style="padding-left: 15px;">{% trans 'The previous health declaration' %}</h6>
                                    <div class="col-12 px-0">
{#                                        <ul class="list-group list-group-flush border-top border-bottom" id="step2_div">#}
{#                                        </ul>#}
{#                                        <div style="height: 30px;"></div>#}
{#                                        <div id="step2_a_div" class="text-center"></div>#}
                                        <form >
                                            <div class="row bottom40">
                                                <div class="col-md-12 col-sm-12 col-xs-12">
                                                    {% if last_health_question_date %}
                                                        <div class="form-group float-label active" >
                                                            <input type="text" class="form-control text-template" style="font-size: 15px;" value="{{ last_health_question_date }}" readonly>
                                                            <label class="form-control-label " style="font-size: 15px;">{% trans 'Date' %}</label>
                                                        </div>
                                                        {% for question_content in last_health_question_list %}
                                                        <div class="form-group float-label active"
                                                                {% if request.COOKIES.language == 'en-us' %}
                                                                    {% if 72 > question_content.2  and question_content.2 > 40 %}
                                                                        style="padding-top:50px;"
                                                                    {% elif question_content.2 >= 72 %}
                                                                        style="padding-top:55px;"
                                                                    {% endif %}
                                                                {% endif %}
                                                        >
                                                            <input type="text" class="form-control text-template" style="font-size: 15px;" value="{{ question_content.1 }}" readonly>
                                                            <label class="form-control-label " style="font-size: 15px;">{{ question_content.0 }}</label>
                                                        </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        {% trans 'Have not fill out the health declaration' %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>

{% endblock %}
{% block js %}
    <!-- cookie js -->
    <script src="{% static 'app_web/vendor/cookie/jquery.cookie.js' %}"></script>

    <!-- chart js -->
    <script src="{% static 'app_web/vendor/chartjs/Chart.min.js' %}"></script>
    <script src="{% static 'app_web/vendor/chartjs/utils.js' %}"></script>

     <!-- page level custom js -->
{#    <script src="{% static 'app_web/js/statistics.js' %}"></script>#}

    <script>
        var server_url;
        function approach_record(next_url){
            var record_list, next_link, api_url, html_str;
            {#var sJson = JSON.stringify({record_type: 'APPROACH', uts: new Date().getTime(),});#}
            if (next_url == 'default'){
                {#if (window.location.port == '8003'){#}
                {#    api_url = 'http://' + window.location.hostname +':' + window.location.port + '/web-user-records/';#}
                {# }else{#}
                {#    api_url = window.location.protocol + '//' + window.location.host + '/web-user-records/';}#}
                api_url = server_url + '/web-user-records/';
            }else{
                api_url = next_url;
            }
            {#alert(api_url);#}
            $.ajax({
                type: 'get',
                url: api_url,
                data: {"record_type": 'APPROACH', "uts": new Date().getTime()},
                headers: {
                    'Content-Type': 'application/json',
                    {#'Accept': 'application/vnd.ani.v1.wallet+json',#}
                    'X-MAI-TOKEN': 'WebUser ' + '{{ request.app_user.api_token }}',
                    {#'X-Client-Version': '1.0',#}
                    'X-Client-Id': '{{ request.app_user.pub_id }}',
                },
                success: function(response) {
                    {#alert(response);#}
                    $.each(response, function(index, value) {
                        if (index == 'results'){
                            record_list = value
                        }
                        if (index == 'next'){
                            if (value != null){
                                value = value.replace('http://web', server_url);
                                document.getElementById('step1_a_div').style.display = "";
                                document.getElementById('step1_a_div').innerHTML = '<a onclick="approach_record(\'' + value +  '\')">' + "{% trans 'More'  %}" + '</a>';
                            }else{
                                document.getElementById('step1_a_div').style.display = "none";
                            }

                        }
                    });

                    for (var i in record_list){
                        html_str = '';
                        html_str += '<li class="list-group-item"><div class="row align-items-center"><div class="col align-self-center pr-0"><h6 class="font-weight-normal mb-1">' +
                            record_list[i]['approach_user'] + '</h6><p class="text-mute small text-secondary">' + record_list[i]['record_time'] + '</p></div><div class="col-auto">';
                        if (record_list[i]['approach_type'] == 'HEALTH'){
                            html_str += '<label class="font-weight-normal">';
                            if (record_list[i]['approach_action'] == 'SCAN'){
                                html_str += '<i class="material-icons" style="font-size: 15px;">smartphone</i><i class="material-icons" style="font-size: 15px;">keyboard_arrow_right</i>';
                            }else{
                                html_str += '<i class="material-icons" style="font-size: 15px;">keyboard_arrow_right</i><i class="material-icons" style="font-size: 15px;">smartphone</i>';
                            }
                            html_str += '</i>' + "{% trans 'Health Scan' %}" + '</label><h6 class="';
                            if (record_list[i]['code_tag'] == 0){
                                html_str += 'text-success'
                            }else{
                                html_str += 'text-danger'
                            }
                            html_str += ' text-right">' + record_list[i]['code_result'] +'</h6>';
                        }else if (record_list[i]['approach_type'] == 'APPROACH'){
                            html_str += '<h6 class="font-weight-normal">' + "{% trans 'Approach Scan' %}" + '</h6>';
                        }else if (record_list[i]['approach_type'] == 'VISITOR'){
                            html_str += '<h6 class="font-weight-normal">' + "{% trans 'Visitor Scan' %}" + '</h6>';
                        }
                        html_str += '</div></div></li>';
                        document.getElementById('step1_div').innerHTML += html_str;
                    }

                },
                error: function(xhr, status, error) {

                    {#alert(xhr.responseText);#}
                    {#var error_result = JSON.parse(xhr.responseText);#}
                    {#alert(error_result[1]);#}
                    {#alert(typeof(error_result.errors.phone[0].code));#}
                    {#alert(error_result.errors.phone[0].message);#}


                }
            });
        }
        function place_record(next_url){
            var record_list, next_link, api_url, html_str;
            {#var sJson = JSON.stringify({record_type: 'APPROACH', uts: new Date().getTime(),});#}
            if (next_url == 'default'){
                {#if (window.location.port == '8003'){#}
                {#    api_url = 'http://' + window.location.hostname +':' + window.location.port + '/web-user-records/';#}
                {# }else{#}
                {#    api_url = window.location.protocol + '//' + window.location.host + '/web-user-records/';}#}
                api_url = server_url + '/web-user-records/';
            }else{
                api_url = next_url;
            }
            {#alert(api_url);#}
            $.ajax({
                type: 'get',
                url: api_url,
                data: {"record_type": 'PLACE', "uts": new Date().getTime()},
                headers: {
                    'Content-Type': 'application/json',
                    {#'Accept': 'application/vnd.ani.v1.wallet+json',#}
                    'X-MAI-TOKEN': 'WebUser ' + '{{ request.app_user.api_token }}',
                    {#'X-Client-Version': '1.0',#}
                    'X-Client-Id': '{{ request.app_user.pub_id }}',
                },
                success: function(response) {
                    {#alert(response);#}
                    $.each(response, function(index, value) {
                        if (index == 'results'){
                            record_list = value
                        }
                        if (index == 'next'){
                            if (value != null){
                                value = value.replace('http://web', server_url);
                                document.getElementById('step2_a_div').style.display = "";
                                document.getElementById('step2_a_div').innerHTML = '<a onclick="place_record(\'' + value +  '\')">' + "{% trans 'More' %}" + '</a>';
                            }else{
                                document.getElementById('step2_a_div').style.display = "none";
                            }

                        }
                    });

                    for (var i in record_list){
                        html_str = '';
                        html_str += '<li class="list-group-item"><div class="row align-items-center"><div class="col align-self-center pr-0"><h6 class="font-weight-normal mb-1">' +
                            record_list[i]['location_name'] + '</h6>';
                        if (record_list[i]['act_name'] != ''){
                            html_str += '<h6 class="font-weight-normal mb-1">' + "{% trans 'Activity Name' %}" + '：' + record_list[i]['act_name'] + '</h6>';
                        }
                        if (record_list[i]['act_org'] != ''){
                            html_str += '<h6 class="font-weight-normal mb-1">' + "{% trans 'Organizer Information' %}" + '：' + record_list[i]['act_org'] + '</h6>';
                        }
                        if (record_list[i]['act_org_contact'] != ''){
                            html_str += '<h6 class="font-weight-normal mb-1">' + "{% trans 'Organiser' %}" + '/' + "{% trans 'Phone' %}" + '：' + record_list[i]['act_org_contact'] + '</h6>';
                        }

                        html_str += '<p class="text-mute small text-secondary">' + record_list[i]['record_time'] + '</p></div></li>';

                        document.getElementById('step2_div').innerHTML += html_str;
                    }

                },
                error: function(xhr, status, error) {

                    {#alert(xhr.responseText);#}
                    {#var error_result = JSON.parse(xhr.responseText);#}
                    {#alert(error_result[1]);#}
                    {#alert(typeof(error_result.errors.phone[0].code));#}
                    {#alert(error_result.errors.phone[0].message);#}


                }
            });
        }
        function work_record(next_url){
            var record_list, next_link, api_url, html_str;
            {#var sJson = JSON.stringify({record_type: 'APPROACH', uts: new Date().getTime(),});#}
            if (next_url == 'default'){
                {#if (window.location.port == '8003'){#}
                {#    api_url = 'http://' + window.location.hostname +':' + window.location.port + '/web-user-records/';#}
                {# }else{#}
                {#    api_url = window.location.protocol + '//' + window.location.host + '/web-user-records/';}#}
                api_url = server_url + '/web-user-records/';
            }else{
                api_url = next_url;
            }
            {#alert(api_url);#}
            $.ajax({
                type: 'get',
                url: api_url,
                data: {"record_type": 'CLOCK_IN', "uts": new Date().getTime()},
                headers: {
                    'Content-Type': 'application/json',
                    {#'Accept': 'application/vnd.ani.v1.wallet+json',#}
                    'X-MAI-TOKEN': 'WebUser ' + '{{ request.app_user.api_token }}',
                    {#'X-Client-Version': '1.0',#}
                    'X-Client-Id': '{{ request.app_user.pub_id }}',
                },
                success: function(response) {
                    {#alert(response);#}
                    $.each(response, function(index, value) {
                        if (index == 'results'){
                            record_list = value
                        }
                        if (index == 'next'){
                            if (value != null){
                                value = value.replace('http://web', server_url);
                                document.getElementById('step3_a_div').style.display = "";
                                document.getElementById('step3_a_div').innerHTML = '<a onclick="work_record(\'' + value +  '\')">' + "{% trans 'More' %}" + '</a>';
                            }else{
                                document.getElementById('step3_a_div').style.display = "none";
                            }

                        }
                    });

                    for (var i in record_list){
                        html_str = '';
                        html_str += '<li class="list-group-item"><div class="row align-items-center"><div class="col align-self-center pr-0"><h6 class="font-weight-normal mb-1">' +
                            record_list[i]['clock_in_place'] + '</h6><p class="text-mute small text-secondary">' + record_list[i]['record_time'] + '</p></div><div class="col-auto">';
                        if (record_list[i]['work_status'] == 0){
                            html_str += '<h6 class="text-success">' + record_list[i]['status_show'] + '</h6>';
                        }else if (record_list[i]['work_status'] == 1){
                            html_str += '<h6 class="text-danger">' + record_list[i]['status_show'] + '</h6>';
                        }
                        html_str += '</div></div></li>';
                        document.getElementById('step3_div').innerHTML += html_str;
                    }

                },
                error: function(xhr, status, error) {

                    {#alert(xhr.responseText);#}
                    {#var error_result = JSON.parse(xhr.responseText);#}
                    {#alert(error_result[1]);#}
                    {#alert(typeof(error_result.errors.phone[0].code));#}
                    {#alert(error_result.errors.phone[0].message);#}


                }
            });
        }
        $(document).ready(function() {

            if (window.location.port == '8003'){
                server_url = 'http://' + window.location.hostname +':' + window.location.port;
            }else{
                server_url = window.location.protocol + '//' + window.location.host + window.location.port;
            }
            approach_record('default');
            place_record('default');
            work_record('default');
            document.getElementsByTagName("title")[0].innerText = '{% trans "History" %}' + ' · ' + '{% trans "My PassCode" %}';
            document.getElementById('backpage').style.display = "none";
            document.getElementById('sidebar').style.display = "";
            document.getElementById('hamburger').style.display = "";
            var theme_color_layout = $.cookie("theme-color-layout");
            var theme_color = $.cookie("theme-color");
            var s;
            if (theme_color == 'black-theme' && theme_color_layout == 'theme-dark'){
                s=document.getElementsByTagName('input');
                for(var i=0;i<s.length;i++)
                {
                    s[i].setAttribute("style","color:white");
                }
            }
        });
        $(window).on('load', function () {
            /* swiper slider carousel */
            var swiper = new Swiper('.icon-slide', {
                slidesPerView: 'auto',
                spaceBetween: 0,
            });
            var swiper = new Swiper('.offer-slide', {
                slidesPerView: 'auto',
                spaceBetween: 0,
            });

            var swiper = new Swiper('.two-slide', {
                slidesPerView: 2,
                spaceBetween: 0,
                pagination: {
                    el: '.swiper-pagination',
                },
            });

            var swiper = new Swiper('.news-slide', {
                slidesPerView: 5,
                spaceBetween: 0,
                pagination: {
                    el: '.swiper-pagination',
                },
                breakpoints: {
                    1024: {
                        slidesPerView: 4,
                        spaceBetween: 0,
                    },
                    768: {
                        slidesPerView: 3,
                        spaceBetween: 0,
                    },
                    640: {
                        slidesPerView: 2,
                        spaceBetween: 0,
                    },
                    320: {
                        slidesPerView: 2,
                        spaceBetween: 0,
                    }
                }
            });


            /* chart js charts   */
            var ctx = document.getElementById("linechart").getContext('2d');

            var gradient2 = ctx.createLinearGradient(0, 0, 0, 200);
            gradient2.addColorStop(0, 'rgba(151, 94, 251, 0.40)');
            gradient2.addColorStop(1, 'rgba(91, 168, 255, 0.40)');

            var chat_config = {
                type: 'line',
                data: {
                    labels: {{ label_list|safe }},
                    datasets: [{
                        label: ' 體溫 ',
                        backgroundColor: gradient2,
                        data: {{ temperature_list|safe }},
                        borderColor: "rgba(151, 94, 251, 0.40)",
                        borderCapStyle: 'butt',
                        borderDash: [],
                        borderWidth: 3,
                        borderDashOffset: 1,
                        borderJoinStyle: 'bevel',
                        pointBorderColor: "#ffffff",
                        pointBackgroundColor: "#7b65f4",
                        pointBorderWidth: 1,
                        pointHoverRadius: 12,
                        pointHoverBackgroundColor: "#7b65f4",
                        pointHoverBorderColor: "#ffffff",
                        pointHoverBorderWidth: 0,
                        pointRadius: 8,
                        pointHitRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    title: {
                        display: false,
                        text: 'Chart.js  Line Chart',
                    },
                    legend: {
                        display: false,
                        labels: {
                            fontColor: "#888888"
                        }
                    },
                    scales: {
                        yAxes: [{
                            display: false,
                            ticks: {
                                fontColor: "#888888",
                                beginAtZero: true,
                                min:28,
                                max:50,
                                stepSize:.001
                            },
                            gridLines: {
                                color: "rgba(160,160,160,0.1)",
                                zeroLineColor: "rgba(160,160,160,0.15)"
                            }
                        }],
                        xAxes: [{
                            display: false,
                            ticks: {
                                fontColor: "#888888"
                            },
                            gridLines: {
                                color: "rgba(160,160,160,0.1)",
                                zeroLineColor: "rgba(160,160,160,0.15)"
                            }
                        }]
                    },
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 0,
                            bottom: 0
                        }
                    },
                    horizontalLine: [{
                        y: 38,
                        style: "rgba(204,105,207,0.4)",
                        text: "37.8"
                    }]
                }
            };

            var horizonalLinePlugin = {
                afterDraw: function (chartInstance) {
                    var yScale = chartInstance.scales["y-axis-0"];
                    var canvas = chartInstance.chart;
                    var ctx = canvas.ctx;
                    var index;
                    var line;
                    var style;

                    if (chartInstance.options.horizontalLine) {
                        for (index = 0; index < chartInstance.options.horizontalLine.length; index++) {
                            line = chartInstance.options.horizontalLine[index];

                            if (!line.style) {
                                style = "rgba(169,169,169, .6)";
                            } else {
                                style = line.style;
                            }

                            if (line.y) {
                                yValue = yScale.getPixelForValue(line.y);
                            } else {
                                yValue = 0;
                            }

                            ctx.lineWidth = 3;

                            if (yValue) {
                                ctx.beginPath();
                                ctx.moveTo(0, yValue);
                                ctx.lineTo(canvas.width, yValue);
                                ctx.strokeStyle = style;
                                ctx.stroke();
                            }

                            if (line.text) {
                                ctx.fillStyle = style;
                                ctx.fillText(line.text, 0, yValue + ctx.lineWidth);
                            }
                        }
                        {#return;#}
                    }
                }
            };
            Chart.pluginService.register(horizonalLinePlugin);

            var myChart = new Chart(ctx, chat_config);


        });
    </script>

{#    <script src="{% static 'app_web/js/statistics.js' %}"></script>#}

{% endblock %}

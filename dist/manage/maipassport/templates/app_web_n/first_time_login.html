{% extends 'app_web_n/base.html' %}
{% load i18n %}
{% load static %}
{% block content %}
    <!-- header -->
        <div class="header">
{#            <div style="height: 23px;"></div>#}
            <div class="row no-gutters">
                <div class="col-auto">
{#                    <a onclick="history.go(-1);" class="btn  btn-link text-dark"><i class="material-icons">chevron_left</i></a>#}
                    <a href="{% url 'app_login' %}" class="btn  btn-link text-dark"><i class="material-icons">chevron_left</i></a>
                </div>
                <div class="col text-center"></div>
                <div class="col-auto">
                </div>
            </div>
        </div>
        <!-- header ends -->
        <div class="row no-gutters login-row">
            <div class="col align-self-center px-3 text-center">
                <br>
                {% if request.session.iii_login %}
                    <img src="{% static 'app_web/img/main_logo.png' %}" alt="logo" class="logo-small">
                {% else %}
                    <img src="{% static 'app_web/img/logo-04b.png' %}" alt="logo" class="logo-small">
                {% endif %}
                <form class="form-signin mt-3 " method="post" action="{% url 'fst_login' %}" id="frm">
                    {% csrf_token %}
{#                    <div class="form-group">#}
{#                        <input type="text" id="account" name="account" class="form-control form-control-lg text-center" placeholder="已註冊之帳號" required autofocus>#}
{#                    </div>#}
                    <div class="form-group">
                        <input type="text" id="account" name="account" class="form-control form-control-lg text-center" placeholder="{% trans 'Please enter login account' %}" required onkeyup='value=value.replace(/[\W]/g, "")'>
                    </div>
                    <div style="height: 10px;"></div>
                    <div class="form-group">
                        <input type="number" id="phone" name="phone" class="form-control form-control-lg text-center" placeholder="{% trans 'Phone Number, ex:0912345678' %}" maxlength="10" required>
                    </div>
                    <div style="height: 10px;"></div>
                    <div class="input-group">
                        <input type="text" id="otp" name="otp" class="form-control form-control-lg text-center" onkeyup="replace_amount(this)" placeholder="{% trans 'Verify code' %}" maxlength="6" required>
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" id="btn_otp">{% trans 'Send verify code' %}</button>
                        </div>
                    </div>
                    <input type="hidden" name="otp_id" id="otp_id">
{#                    <div class="form-group">#}
{#                        <input type="password" id="chkpassword" name="chkpassword" class="form-control form-control-lg text-center" placeholder="再次輸入新密碼" required>#}
{#                    </div>#}

                    <!--<div class="form-group my-4 text-left">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="rememberme">
                            <label class="custom-control-label" for="rememberme">Remember Me</label>
                        </div>
                    </div>-->

{#                    <p class="text-secondary mt-4 d-block">如果您有密碼可登入,<br>請在點選 <a href="forgot-password.html" class="">重新發送驗證碼</a></p>#}
{#                    <p class="text-secondary mt-4 d-block"><a id="resend_a" class="">重新發送驗證碼</a></p>#}
                </form>
            </div>
        </div>


        <!-- login buttons -->
        <div class="row mx-0 bottom-button-container">
            <div class="col">
                <a onclick="frm_submit()" class="btn btn-default btn-lg btn-rounded shadow btn-block" id="btn_next">{% trans 'Next, set password' %}</a>
            </div>
        </div>
        <!-- login buttons -->
{% endblock %}
{% block js %}
<script>
    var interval = null;
    var cd_sec_val = 60;
    function replace_amount(obj) {
        obj.value = obj.value.replace(/[^\d]/g,'');
    }
    function count_down(){

        {#var cd_sec = $("#cd_sec").text();#}
        {#var cd_sec_val = parseInt(cd_sec);#}
        cd_sec_val = cd_sec_val - 1;

        //alert(cd_sec_val);

        if (cd_sec_val <= 0){
            clearInterval(interval);
            $("#btn_otp").removeAttr('disabled');
            $("#btn_otp").text('{% trans 'Send verify code' %}');
            return
        }
        $("#btn_otp").text(cd_sec_val + '{% trans " seconds to send" %}');
        {#$("#cd_sec").text(cd_sec_val);#}
    }
    function send_otp(){
        var sJson = JSON.stringify
        ({
            uts: new Date().getTime(),
            phone: $('#phone').val(),
            account: $('#account').val(),
            device_id: $('#account').val(),
            otp_text_type: 'APP'
        });
        {#alert('sendding');#}
        if (window.location.port == '8003'){
            var otp_url = 'http://' + window.location.hostname +':' + window.location.port + '/web_otp_send/';
        }else{
            var otp_url = window.location.protocol + '//' + window.location.hostname + '/web_otp_send/';
        }
        $.ajax({
            type: 'POST',
            url: otp_url,
            {#data: "uts="+ new Date().getTime()+"&purchase_amount="+ s_amount, // serializes the form's elements.#}
            data: sJson,
            dataType: 'json',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
                {#'Accept': 'application/vnd.ani.v1.wallet+json',#}
                'X-MAI-TOKEN': 'DeviceUser 5c7e9f90fa2e23502cc121afed142a78d91eb81c373f9139df2d1adff4412b1d852bef3257d4192554065ff8df2331eb9ffde930915bdaaf4eb13f17aa2eeb1f',
                'X-Client-Version': '1.0',
                'X-Client-Id': '0M7jDJ07t-TQTn-XqV5S',
            },
            success: function(response) {
                {#alert(response);#}
                $.each(response, function(otp_index, otp_value) {
                    $("#otp_id").val(otp_value);
                });
                {#alert('已送出otp');#}
                $("#msg").text('{% trans "Verify code already send" %}');
                $("#message_modal").modal();
                {#var result_data = JSON.parse(response.data);#}
                {#alert(result_data.otp_id);#}
                $("#btn_otp").attr('disabled', true);
                cd_sec_val = 60;
                interval = setInterval(function(){ count_down(); }, 1000);
            },
            error: function(xhr, status, error) {

                {#alert(error);#}
                var error_result = JSON.parse(xhr.responseText);
                {#alert(xhr.status);#}
                {#alert(error_result.error.message);#}
                {#alert(error_result.error.m);#}
                if (error_result){
                    var error_code = "";
                    if (error_result.error){
                        error_code = error_result.error.code;
                    }
                    else if (error_result.errors){
                        error_code = error_result.errors.phone[0].code;
                    }
                    if(error_code == 'throttled'){
                        var otp_resend_time = error_result.error.message.replace('Request was throttled. Expected available in ', '');
                        otp_resend_time = otp_resend_time.replace(' seconds.', '');

                        cd_sec_val = parseInt(otp_resend_time);
                        interval = setInterval(function(){ count_down(); }, 1000);

                        {#alert("{% trans 'Waiting ' %}" + otp_resend_time + "{% trans ' seconds to send' %}");#}
                        $("#msg").text("{% trans 'Waiting ' %}" + otp_resend_time + "{% trans ' seconds to send' %}");
                        $("#message_modal").modal();
                    {# }else if (error_code == 'otp_send_too_close'){#}
                        {#alert(error_result.error.message);#}
                    {#    $("#msg").text(error_result.error.message);#}
                    {#    $("#message_modal").modal();#}
                    }else if (error_code == 'invalid'){
                        $("#msg").text(error_result.errors.phone[0].message);
                        $("#message_modal").modal();
                    }else if (error_code != undefined || error_code != ''){
                        {#alert(error_result.error.message);#}
                        $("#msg").text(error_result.error.message);
                        $("#message_modal").modal();
                    }else{
                        $("#msg").text("{% trans 'Send verify code error' %}");
                        $("#message_modal").modal();
                    }
                }else{
                    $("#msg").text("{% trans 'Send verify code error' %}");
                    $("#message_modal").modal();

                }

            }
        });
    }
    $("#btn_otp").on('click', function (){
        {#alert("aaaaa");#}
        if ($('#account').val() == ''){
            $("#msg").text('{% trans "Please enter account" %}');
            $("#message_modal").modal();
        }else if ($('#phone').val() == ''){
            $("#msg").text('{% trans "Please enter phone" %}');
            $("#message_modal").modal();
        }else{

            send_otp()
        }
    });
    $(document).ready(function() {
        document.getElementById('header_tab').style.display = "none";
        document.getElementById('header_bar').style.display = "none";
        document.getElementById('sidebar').style.display = "none";
        document.getElementsByTagName("title")[0].innerText = '{% trans "First Time Login" %}' + ' · ' + '{% trans "My PassCode" %}';
        {#document.getElementById('back_login_a').style.display = "";#}
        {#document.getElementById('back_history_a').style.display = "none";#}

        var theme_color_layout = $.cookie("theme-color-layout");
        var theme_color = $.cookie("theme-color");
        if (theme_color == 'black-theme' && theme_color_layout == 'theme-dark'){
            document.getElementById('btn_next').style.backgroundColor = '#2c2c2c';
            {#document.getElementById('resend_a').style.color = 'white';#}
            document.getElementById('send_target').style.color = 'white';
            document.getElementById('otp').style.color = 'white';
            {#document.getElementById('chkpassword').style.color = 'white';#}

        }
    });
    function frm_submit() {
        var frm = $('#frm');
        if (frm[0].checkValidity()) {
            if ($('#otp_id').val() == ''){
                $("#msg").text('{% trans "Press send verify code button" %}');
                $("#message_modal").modal();
            }else{
                frm.submit();
            }
        }else{
            frm[0].reportValidity();
        }
    }
</script>

{% endblock %}


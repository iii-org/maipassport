{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en" >
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>健康通行人員防疫管理平台</title>
<!-- Bootstrap -->
<link href="{% static 'backend/css/bootstrap.css' %}" rel="stylesheet">
<link href="{% static 'backend/css/default.css' %}" rel="stylesheet">
<link rel="stylesheet" href="{% static 'backend/css/layout.css' %}" />
<link rel="stylesheet" href="{% static 'backend/css/type.css' %}" />
<link rel="stylesheet" href="{% static 'backend/css/nav.css' %}" />
<link rel="stylesheet" href="{% static 'backend/fontawesome-free-5.3.1-web/css/all.css' %}">
<script type="text/javascript" src="{% static 'backend/js/jquery.min.js' %}"></script>
<script type="text/javascript" src="{% static 'backend/js/navActive.js' %}"></script>
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
              <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
              <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
            <![endif]-->
<style>
    .modal {
            text-align: center;
            padding: 0!important;
        }

        .modal:before {
            content: '';
            display: inline-block;
            height: 100%;
            vertical-align: middle;
            margin-right: -4px;
        }

        .modal-dialog {
            display: inline-block;
            text-align: left;
            vertical-align: middle;
        }

        nav ul.mainNav > li {
            z-index: 100;
        }
</style>
</head>
<body>
<div class="container-fluid" style="height:75px; background-color: #3f97ce; background-image: url({% static 'backend/images/banner.jpg' %}); background-size: cover; background-position:center center; background-repeat: no-repeat;  font-size: 16px; ">
    <div class="container ">
    <div class="row">
      <div class="col-md-4 col-sm-4 nopadding">
        <div style="font-size:24px;font-weight:900;padding:8px;color:#fff">健康通行人員防疫管理平台</div>
      </div>
{#        <div class="col-md-8 col-sm-8 text-right top15">#}
{#            {% if request.user_object.username %}#}
{#                <div style="font-size:16px; color: #FFF;">您好! {{ request.user_object.username }}(管理員)  </div>#}
{#            {% else %}#}
{#                <div style="font-size:16px; color: #FFF;">請先登入</div>#}
{#            {% endif %}#}
{#        </div>#}
    </div>
  </div>
</div>
<div class="container top70">
    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12 top20 bottom20" style="font-size:25px; font-weight:bold;">帳號綁定<img src="{% static 'backend/images/LINE.png' %}" class="img-responsive top5" alt="" /> </div>
    </div>
</div>
<div class="container bottom80">
    <div class="text-center">
        <div class="row ">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div style="background-color:#f4f4f4;font-size: 15px;padding:45px 0 15px;">
                    <input type="hidden" name="return_msg" id="return_msg" value="{{ return_msg }}">
                    <form method="post" action="{% url 'user_verify' %}" id="frm">
                        {% csrf_token %}
                        <input type="hidden" name="otp_id" id="otp_id" value="{{ otp_id }}">
                        <div class="form-group">
                            <label class="col-md-4 control-label text-right">帳號</label>
                            <div class="col-md-4 col-sm-12 col-xs-12 text-left">
                                <input type="text" class="bottom5 form-control" placeholder="請輸入登入帳號" name="account" id="account" required>
                            </div>
                            <div class="col-md-4"></div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-4 control-label text-right">欲綁定電話</label>
                            <div class="col-md-4 col-sm-12 col-xs-12 text-left">
                                <input type="number" class="bottom5 form-control" placeholder="請輸入電話, ex: 0912345678" id="phone" maxlength="10" name="phone" required>
                            </div>
                            <div class="col-md-4"></div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-4 control-label text-right">驗證碼</label>
                            <div class="col-md-4 col-sm-12 col-xs-12 text-left">

                                <div class="input-group bottom10">
                                    <input type="number" class="form-control" placeholder="請輸入收到的驗證碼" name="otp" maxlength="6">
                                    <span class="input-group-btn">
                                        <button class="btn btn-default" type="button" style="color:#000;" id="btn_otp">發送驗證碼</button>
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4"></div>
                        </div>
                        <div class="form-group">
                            <div class="col-md-4"></div>
                            <div class="col-md-4 text-center">
                                <button type="submit" class="btn " style="background-color: dodgerblue; color:white;" onclick="frm_submit()">綁定電話</button>
                                <button type="button" class="btn " style="background-color: #96bfbf; color:white;" onclick="back_login()">取消</button>
                            </div>
                            <div class="col-md-4"></div>
                        </div>
{#                        <div style="padding-top: 20px;">#}
{#                            <label style="color: black; ">請輸入帳號</label>#}
{#                            <input type="text" class="form-control" style="color:white;background-color: rgba(255,255,255,0); border-color: rgba(255,255,255,0);border-bottom: 1px solid white; " name="account">#}
{#                        </div>#}
{#                        <div style="padding-top: 20px;">#}
{#                            <label style="color: black; ">請輸入登入密碼</label>#}
{#                            <input type="password" class="form-control" style="color:white;background-color: rgba(255,255,255,0); border-color: rgba(255,255,255,0);border-bottom: 1px solid white; " name="password">#}
{#                        </div>#}
{#                        <div style="padding-top: 50px;">#}
{#                            <button type="submit" class="btn form-control" style="background-color: dodgerblue; color:white;">登入</button>#}
{#                            <div style="height: 20px;"></div>#}
{#                            <button type="submit" class="btn form-control" style="color:white; background-color: #8ea2b4">一般註冊</button>#}
{#                        </div>#}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{#<div class="text-center">#}
{#    <img src="{% static 'images/iii.png' %}" height="30" width="40" />#}
{#    <label style="color: white; padding-top: 40px;">財團法人資訊工業策進會</label>#}
{#</div>#}
{#<div class="container" style="padding-top: 40px">#}
{#    <form method="post" action="{% url 'app_login' %}">#}
{#        {% csrf_token %}#}
{#        <div style="padding-top: 20px;">#}
{#            <label style="color: white; background-image: url({% static 'images/login_bg.png' %});">請輸入帳號</label>#}
{#            <input type="text" class="form-control" style="color:white;background-color: rgba(255,255,255,0); border-color: rgba(255,255,255,0);border-bottom: 1px solid white; " name="account">#}
{#        </div>#}
{#        <div style="padding-top: 20px;">#}
{#            <label style="color: white; background-image: url({% static 'images/login_bg.png' %});">請輸入登入密碼</label>#}
{#            <input type="password" class="form-control" style="color:white;background-color: rgba(255,255,255,0); border-color: rgba(255,255,255,0);border-bottom: 1px solid white; " name="password">#}
{#        </div>#}
{#        <div style="padding-top: 50px;">#}
{#            <button type="submit" class="btn form-control" style="background-color: dodgerblue; color:white;">登入</button>#}
{#            <div style="height: 20px;"></div>#}
{#            <button type="submit" class="btn form-control" style="color:white; background-color: #8ea2b4">一般註冊</button>#}
{#        </div>#}
{#    </form>#}
{#</div>#}

<!-- Footer -->
     <footer class="container-fluid " style="background-color:#e6e7ef;">
        <div class="row top20 bottom10">
            <div class="col-lg-offset-1 col-lg-3 col-md-4">
                <img src="{% static 'backend/images/logo.jpg' %}" class="img-responsive img-center" alt="" />
            </div>
            <div class="col-lg-7 col-md-8">
                <p class="left" style="font-size: 10px;">
                    版權所有© 2020財團法人資訊工業策進會 ｜ 限會內同仁公務使用禁止對外公開
                    <br>財團法人資訊工業策進會機密資料 禁止複製、轉載、外流 III CONFIDENTIAL DOCUMENT DO NOT COPY OR DISTRIBUTE
                    <br>資訊處資訊服務櫃台： servicedesk@iii.org.tw (電話：6631-8185)
                    <a href="https://teams.microsoft.com/l/chat/0/0?users=servicedesk@iii.org.tw" ptooltip="Teams 聯繫客服窗口" target="_blank" tooltipposition="top"><img src="{% static 'backend/images/teams.png' %}" height="28px;" width="28px;" style="float: none"></a>
                </p>
            </div>
        </div>
    </footer>

<!-- Modal -->
	<div class="modal fade" id="otp_send_notify" tabindex="-1" role="dialog" aria-labelledby="ModalCenterTitle"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <label class="modal-title text-template" id="exampleModalLabel">小提示</label>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" >
                        <div class="row">
                            <div class="col text-center">
                                <p id="msg"></p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                    </div>
                </div>
            </div>
        </div>


<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="{% static 'backend/js/bootstrap.js' %}"></script>
<script>
    var interval = null;
    var cd_sec_val = 60;

    function count_down(){

        {#var cd_sec = $("#cd_sec").text();#}
        {#var cd_sec_val = parseInt(cd_sec);#}
        cd_sec_val = cd_sec_val - 1;

        //alert(cd_sec_val);

        if (cd_sec_val <= 0){
            clearInterval(interval);
            $("#btn_otp").removeAttr('disabled');
            $("#btn_otp").text('發送驗證碼');
            return
        }
        $("#btn_otp").text(cd_sec_val + '秒後可重新發送');
        {#$("#cd_sec").text(cd_sec_val);#}
    }
    function back_login() {
        var api_url = "{% url 'backend_login' %}";
        location.href=api_url;
    }
    function send_otp(){
      var sJson = JSON.stringify
        ({
            uts: new Date().getTime(),
            account: $('#account').val(),
            phone: $('#phone').val(),
            device_id: $('#account').val(),
            otp_text_type: 'BACKEND'
        });
      {#alert('sendding');#}
      if (window.location.port == '8003'){
          var otp_url = 'http://' + window.location.hostname +':' + window.location.port + '/web_otp_send/';
        }else{
          var otp_url = window.location.protocol + '//' + window.location.hostname + '/web_otp_send/';
        }
        $.ajax({
            type: 'POST',
            url: otp_url,
            {#data: "uts="+ new Date().getTime()+"&purchase_amount="+ s_amount, // serializes the form's elements.#}
            data: sJson,
            dataType: 'json',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
                {#'Accept': 'application/vnd.ani.v1.wallet+json',#}
                'X-MAI-TOKEN': 'DeviceUser 5c7e9f90fa2e23502cc121afed142a78d91eb81c373f9139df2d1adff4412b1d852bef3257d4192554065ff8df2331eb9ffde930915bdaaf4eb13f17aa2eeb1f',
                'X-Client-Version': '1.0',
                'X-Client-Id': '0M7jDJ07t-TQTn-XqV5S',
            },
            success: function(response) {
                {#alert(response);#}
                $.each(response, function(otp_index, otp_value) {
                    $("#otp_id").val(otp_value);
                });
                {#alert('已送出otp');#}
                $("#msg").text('OTP驗證碼已發送');
                $("#otp_send_notify").modal();
                {#var result_data = JSON.parse(response.data);#}
                {#alert(result_data.otp_id);#}
                $("#btn_otp").attr('disabled', true);
                cd_sec_val = 60;
                interval = setInterval(function(){ count_down(); }, 1000);
            },
            error: function(xhr, status, error) {

                var error_result = JSON.parse(xhr.responseText);
                {#alert(xhr.status);#}
                {#alert(error_result.error.message);#}
                {#alert(error_result.error.code);#}
                if (error_result){
                    var error_code = "";
                    if (error_result.error){
                        error_code = error_result.error.code;
                    }
                    else if (error_result.errors){
                        error_code = error_result.errors.phone[0].code;
                    }
                    if(error_code == 'throttled'){
                        var otp_resend_time = error_result.error.message.replace('Request was throttled. Expected available in ', '');
                        otp_resend_time = otp_resend_time.replace(' seconds.', '');
                        {#alert("{% trans 'Waiting ' %}" + otp_resend_time + "{% trans ' seconds to send' %}");#}
                        cd_sec_val = parseInt(otp_resend_time);
                        interval = setInterval(function(){ count_down(); }, 1000);
                        $("#msg").text("{% trans 'Waiting ' %}" + otp_resend_time + "{% trans ' seconds to send' %}");
                        $("#otp_send_notify").modal();
                        {# }else if (error_code == 'otp_send_too_close'){#}
                        {#alert(error_result.error.message);#}
                        {#    $("#msg").text(error_result.error.message);#}
                        {#    $("#otp_send_notify").modal();#}
                    }else if (error_code == 'invalid'){
                        $("#msg").text(error_result.errors.phone[0].message);
                        $("#otp_send_notify").modal();
                    }else if (error_code != undefined || error_code != ''){
                        {#alert(error_result.error.message);#}
                        $("#msg").text(error_result.error.message);
                        $("#otp_send_notify").modal();
                    }else{
                        $("#msg").text("{% trans 'Send verify code error' %}");
                        $("#otp_send_notify").modal();
                    }
                }else{
                    $("#msg").text("{% trans 'Send verify code error' %}");
                    $("#otp_send_notify").modal();

                }

            }
        });
    }
    $("#btn_otp").on('click', function (){
      {#alert("aaaaa");#}
        if ($('#account').val() == ''){
            $("#msg").text('請輸入帳號');
            $("#otp_send_notify").modal();
        }else if ($('#phone').val() == ''){
            $("#msg").text('請輸入電話');
            $("#otp_send_notify").modal();
        }else{

            send_otp()
        }
    });
    $(document).ready(function() {
        if ($('#return_msg').val() != ''){
            $("#msg").text($('#return_msg').val() );
              $("#otp_send_notify").modal();
        }
    });
    function frm_submit() {
        var frm = $('#frm');
        if (frm[0].checkValidity()) {
            if ($('#otp_id') == ''){
                $("#msg").text('請發送驗證碼');
                $("#message_modal").modal();
            }else{
                frm.submit();
            }
        }else{
            frm[0].reportValidity();
        }
    }
</script>
</body>
</html>
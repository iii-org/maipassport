{% extends 'backend/base.html' %}
{% load static %}
{% load i18n %}
{% load utils %}
{% block stylesheet %}
    <style>
    nav ul.mainNav > li {
            z-index: 100;
        }
    </style>
{% endblock %}
{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-md-10 col-sm-10 col-xs-10 bread-sec">
                <a href="{% url 'backend_index' %}" style="color:#868686;text-decoration: none;"> 首頁 </a>><a style="color:#868686;text-decoration: none;"> 系統管理 </a>><a href="{% url 'user_management' %}" style="color:#868686;text-decoration: none;"> 使用者管理 </a>
{#                ><a href="#" style="color:#868686;text-decoration: none;">部門晉升提報與查詢</a> </div>#}
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12 " style="margin: 20px 0 20px 0px;font-size:25px; "> 使用者管理 <img src="{% static 'backend/images/LINE.png' %}" class="img-responsive top5" alt="" /> </div>
        </div>
    </div>
    <div class="container bottom40">
        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12 " >
                <div style="font-size: 15px;">
                    <div class=" col-lg-12 col-xs-12 ">
                        <form class="form-horizontal"  method="get" id="frm">
                            <input type="hidden" value="{{ request.GET.per_page_num }}" id="per_page_num" name="per_page_num">
                            <div class="form-group ">
                                <div class="col-md-4">
{#                                    <input type="text" class="form-control inputBox form-control pull-left sndMt10" placeholder="使用者名稱" id="user_first_name" name="user_first_name" value="{{ request.GET.user_first_name }}">#}
                                    <select class="form-control selectpicker" name="user_first_name" id="user_first_name" data-live-search="true" title="{% trans 'Please Select User' %}" >
                                        <option value="">無</option>
                                        {% for app_user_name in app_user_name_list %}
                                            <option {% if request.GET.user_first_name == app_user_name %}selected{% endif %} value="{{ app_user_name }}">{{ app_user_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-control selectpicker" name="user_account" id="user_account" data-live-search="true" title="{% trans 'Please Select Account' %}" >
                                        <option value="">無</option>
                                        {% for app_user_account in app_user_account_list %}
                                            <option {% if request.GET.user_account == app_user_account %}selected{% endif %} value="{{ app_user_account }}">{{ app_user_account }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-control selectpicker" name="user_role" id="user_role" data-live-search="true" title="{% trans 'Please Select User Role' %}">
                                        <option value="">無</option>
                                        {% for user_role in user_role_list %}
                                            <option value="{{ user_role.0 }}" {% if request.GET.user_role == user_role.0 %}selected{% endif %}>{{ user_role.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group ">
                                <div class="col-md-4">
                                    <select class="form-control selectpicker" name="company_name" id="company_name" onchange="company_select()" data-live-search="true" title="{% trans 'Please Select Company / School' %}" >
                                        <option value="">無</option>
                                        {% for company in company_list %}
                                            <option value="{{ company }}" {% if request.GET.company_name == company %}selected{% endif %}>{{ company }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-control selectpicker" name="department_name" id="department_name" data-live-search="true" title="{% trans 'Please Select Department' %}">
{#                                        <option value="">部門</option>#}
                                        <option value="">無</option>
                                    </select>
                                </div>

                            </div>
                            <div class="form-group">
                                <label for="exampleInputPassword1" class="col-md-1 control-label sndMt15 left15">建立日期：</label>
                                <div class="col-md-7">
                                    <div class="selectBox">
                                        <div class="inputBox pull-left input-group sndMt10 datetime" id="datetimepicker_min" >
                                            <input type="text" class="form-control" placeholder="" name="created_at_min" id="created_at_min" value="{{ request.GET.created_at_min }}">
                                            <span class="input-group-addon">
{#                    <button class="btn btn-default" type="button" style="color:#000;"><i class="fas fa-calendar-alt"></i></button>#}
                                                <span class="glyphicon glyphicon-calendar"></span>
                                            </span>
                                        </div>
                                        <span class="tilde text-center pull-left">~</span>
                                        <div class="inputBox pull-left input-group sndMt10 datetime" id="datetimepicker_max">
                                            <input type="text" class="form-control" placeholder="" name="created_at_max" id="created_at_max" value="{{ request.GET.created_at_max }}">
                                            <span class="input-group-addon">
{#                    <button class="btn btn-default" type="button" style="color:#000;"> <i class="fas fa-calendar-alt"></i> </button>#}
                                                <span class="glyphicon glyphicon-calendar"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-3 text-right">
                                    <button type="button" class="btn btn-default" style="background:#8b8c8c;color:#fff; " onclick="reset_frm()">清除搜尋</button>
                                    <button type="submit" class="btn btn-default" style="background:#6fa1bf;color:#fff; ">搜尋使用者</button>
                                </div>
{#                                <div class="text-right col-md-2 ">#}
{#                                    <button type="button" class="btn btn-default" style="background:#8b8c8c;color:#fff; ">清除搜尋</button>#}
{#                                </div>#}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
{#        <div class="col-12">#}
{#            <div class="col-2">#}
{#                <button type="submit" class="btn btn-default" style="background:#335eb6;color:#fff; ">更新後台管理者</button>#}
{#                <button type="submit" class="btn btn-default" style="background:#8b8c8c;color:#fff; ">搜尋使用者</button>#}
{#            </div>#}
{#        </div>#}

        <div class="pc_top row top20">
            <div class="col-md-12 col-sm-12 col-xs-12" style="font-size: 16px;">
                <table class="table table-striped table-bordered" >
{#                    <thead>#}
                        <tr>
{#                            <th class="cen_blue">#}
{#                                <label><input type="checkbox" id="all_check">&nbsp;後台管理者</label>#}
{#                                後台管理者#}
{#                            </th>#}
                            <th class="text-center cen_blue">名稱</th>
                            <th class="text-center cen_blue">帳號</th>
                            <th class="text-center cen_blue">公司/學校</th>
                            <th class="text-center cen_blue">部門</th>
                            <th class="text-center cen_blue">管理者</th>
                            <th class="text-center cen_blue">部門管理者</th>
                            <th class="text-center cen_blue">健康碼更新權限</th>
                            <th class="text-center cen_blue">建立日期</th>
                            <th class="text-center cen_blue">查看</th>
                        </tr>
{#                    </thead>#}
                        {% for app_user in app_user_list %}
                            <tr>
{#                                <td class="cen text-center">#}
{#                                    <label>#}
{#                                        <input type="checkbox" {% if app_user.admin_flag %}checked{% endif %} value="{{ app_user.pub_id }}">#}
{#                                    </label>#}
{#                                </td>#}
                                <td class="cen text-center">{{ app_user.auth_user.first_name }}</td>
                                <td class="cen text-center">{{ app_user.auth_user.username }}</td>
                                <td class="cen text-center" >
                                    {% if app_user.default_company.pub_id %}
                                        <a href="{% url 'company_detail' app_user.default_company.pub_id %}">{{ app_user.default_company.name }}</a>
                                    {% endif %}
                                </td>
                                <td class="cen text-center" >
                                    {% if app_user.default_company.pub_id %}
                                        {{ app_user.default_department.name }}
                                    {% endif %}
                                </td>
                                <td class="cen text-center" >
                                    {% if app_user.default_company.pub_id %}
                                        {% if app_user.admin_flag %}
                                            是
                                            <a onclick="update_user_manage('{{ app_user.pub_id }}', '{{ app_user.default_company.pub_id }}', 'DEFAULT', '0', 'MANAGEMENT', 'MANAGE')"><i class="fas fa-edit"></i></a>
                                        {% else %}
                                            否
                                            <a onclick="update_user_manage('{{ app_user.pub_id }}', '{{ app_user.default_company.pub_id }}', 'DEFAULT', '1', 'MANAGEMENT', 'MANAGE')"><i class="fas fa-edit"></i></a>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                 <td class="cen text-center" >
                                    {% if app_user.default_company.pub_id %}
                                        {% if app_user.dep_manage %}
                                            是
                                            <a onclick="update_user_manage('{{ app_user.pub_id }}', '{{ app_user.default_company.pub_id }}', 'DEFAULT', '0', 'MANAGEMENT', 'DEP_MANAGE')"><i class="fas fa-edit"></i></a>
                                        {% else %}
                                            否
                                            <a onclick="update_user_manage('{{ app_user.pub_id }}', '{{ app_user.default_company.pub_id }}', 'DEFAULT', '1', 'MANAGEMENT', 'DEP_MANAGE')"><i class="fas fa-edit"></i></a>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="cen text-center" >
                                    {% if app_user.default_company.pub_id %}
                                        {% if app_user.scan_enabled %}
                                            是
                                            <a onclick="update_user_manage('{{ app_user.pub_id }}', '{{ app_user.default_company.pub_id }}', 'DEFAULT', '0', 'MANAGEMENT', 'SCAN')"><i class="fas fa-edit"></i></a>
                                        {% else %}
                                            否
                                            <a onclick="update_user_manage('{{ app_user.pub_id }}', '{{ app_user.default_company.pub_id }}', 'DEFAULT', '1', 'MANAGEMENT', 'SCAN')"><i class="fas fa-edit"></i></a>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="cen text-center">{{ app_user.created | date:"Y-m-d H:i:s" }}</td>
                                <td class="cen text-center"><a href="{% url 'user_detail' app_user.pub_id %}"><i class="fas fa-search"></i></a></td>
                            </tr>
                        {% endfor %}
                </table>
            </div>
            <div class="col-md-1"></div>
            <div class="col-md-11 col-xs-12 top10 ">
                <ul class="pagination" style="float: left;">
                    <li class="page-item {% if app_user_list.number == 1 %}disabled{% endif %}">
                        <a href="{{ request.get_full_path|change_page:1 }}" aria-label="Previous">首頁 </a>
                    </li>
                    <li class="page-item {% if not app_user_list.has_previous %}disabled{% endif %}">
                        {% if app_user_list.has_previous %}
                            <a href="{{ request.get_full_path|change_page:app_user_list.previous_page_number }}" aria-label="Previous">上頁 </a>
                        {% else %}
                            <a href="#" aria-label="Previous">上頁 </a>
                        {% endif %}
                    </li>
                    {% for num in page_range %}
                        <li class="page-item {% if num == app_user_list.number %}active{% endif %}"><a href="{{ request.get_full_path|change_page:num }}">{{ num }}</a></li>
                    {% endfor %}
                    <li class="page-item {% if not app_user_list.has_next %}disabled{% endif %}">
                        {% if app_user_list.has_next %}
                            <a href="{{ request.get_full_path|change_page:app_user_list.next_page_number }}" aria-label="Next">下頁 </a>
                        {% else %}
                            <a href="#" aria-label="Next">下頁 </a>
                        {% endif %}
                    </li>
                    <li class="page-item {% if app_user_list.number == app_user_list.paginator.num_pages %}disabled{% endif %}" >
                        <a href="{{ request.get_full_path|change_page:app_user_list.paginator.num_pages }}" aria-label="Next">末頁 </a>
                    </li>
                </ul>
                <div class="col-md-5 top20">
                    <div style="color:#000;float: left;margin:10px  ">每頁顯示</div>
                    <div class="col-md-4 col-xs-12 bottom10">
                        <select class="form-control selectpicker" onchange="resize_list_num()" id="per_page_num_sel">
                            <option {% if request.GET.per_page_num == '10' %}selected{% endif %} value="10">10</option>
                            <option {% if request.GET.per_page_num == '20' %}selected{% endif %} value="20">20</option>
                        </select>
                    </div>
                    <div style="color:#000;float: left;margin:10px  ">筆(共{{ user_length }}筆)</div>
                </div>
            </div>
        </div>
        <div class="mobile_top row top20">
            <div class="mobile_top col-xs-12" style="font-size: 14px;">
                <table class="table table-striped table-bordered" >
                    <tr>
                        <th class="text-center cen_blue">名稱</th>
                        <th class="text-center cen_blue">公司/學校</th>
                        <th class="text-center cen_blue">部門</th>
                    </tr>
                    {% for app_user in app_user_list %}
                        <tr onclick="mobile_table_click('{{ app_user.pub_id }}')">
                            <td class="cen text-center">{{ app_user.auth_user.first_name }}</td>
                            <td class="cen text-center">
                                {% if app_user.default_company.pub_id %}
                                    <a href="{% url 'company_detail' app_user.default_company.pub_id %}">{{ app_user.default_company.name }}</a>
                                {% endif %}
                            </td>
                            <td class="cen text-center" >
                                {% if app_user.default_company.pub_id %}
                                    {{ app_user.default_department.name }}
                                {% endif %}
                            </td>
                        </tr>

                    {% endfor %}
                </table>
            </div>
            <div class="top10" style="margin-right: 50px;">
                <ul class="pagination" style="float: left;">
                    <li class="page-item {% if app_user_list.number == 1 %}disabled{% endif %}">
                        <a href="{{ request.get_full_path|change_page:1 }}" aria-label="Previous">首頁 </a>
                    </li>
                    <li class="page-item {% if not app_user_list.has_previous %}disabled{% endif %}">
                        {% if app_user_list.has_previous %}
                            <a href="{{ request.get_full_path|change_page:app_user_list.previous_page_number }}" aria-label="Previous">上頁 </a>
                        {% else %}
                            <a href="#" aria-label="Previous">上頁 </a>
                        {% endif %}
                    </li>
                    {% for num in page_range %}
                        <li class="page-item {% if num == app_user_list.number %}active{% endif %}"><a href="{{ request.get_full_path|change_page:num }}">{{ num }}</a></li>
                    {% endfor %}
                    <li class="page-item {% if not app_user_list.has_next %}disabled{% endif %}">
                        {% if app_user_list.has_next %}
                            <a href="{{ request.get_full_path|change_page:app_user_list.next_page_number }}" aria-label="Next">下頁 </a>
                        {% else %}
                            <a href="#" aria-label="Next">下頁 </a>
                        {% endif %}
                    </li>
                    <li class="page-item {% if app_user_list.number == app_user_list.paginator.num_pages %}disabled{% endif %}" >
                        <a href="{{ request.get_full_path|change_page:app_user_list.paginator.num_pages }}" aria-label="Next">末頁 </a>
                    </li>
                </ul>
                <div class="top20">
                    <div style="color:#000;float: left;margin:10px  ">每頁顯示</div>
                    <div class="col-md-4 col-xs-12 bottom10">
                        <select class="form-control selectpicker" onchange="resize_list_num()" id="per_page_num_sel">
                            <option {% if request.GET.per_page_num == '10' %}selected{% endif %} value="10">10</option>
                            <option {% if request.GET.per_page_num == '20' %}selected{% endif %} value="20">20</option>
                        </select>
                    </div>
                    <div style="color:#000;float: left;margin:10px  ">筆(共{{ user_length }}筆)</div>
                </div>
            </div>
        </div>
    </div>
    <!-- DialogIconedInfo -->
{#    <div class="modal fade " id="UserDetailModal" data-backdrop="static" tabindex="-1" role="dialog">#}
{#        <div class="modal-dialog" role="document">#}
{#            <div class="modal-content">#}
{#                <form method="post" >#}
{#                    {% csrf_token %}#}
{#                    <div class="card-header">#}
{#                        <h4 class="card-title" style="font-size: 1.4em; font-weight: 400; font-family: 'Noto Sans TC', sans-serif;">輸入賽局結果</h4>#}
{#                    </div>#}
{#                    <div class="modal-body">#}
{#                        <div class="row">#}
{#                            <div class="col-md-12">#}
{#                                <div class="form-group">#}
{#                                    <label class="bmd-label-floating" >請選擇此期數賽局結果</label>#}
                                    {#                                                <input type="text" class="form-control" name="account" id="account" style="color: black;">#}
{#                                    <select class="form-control" id="game_result" name="game_result" style="color:black;"></select>#}
{#                                    <input type="hidden" id="update_game_id" name="update_game_id">#}
{#                                </div>#}
{#                            </div>#}
{#                        </div>#}
{#                    </div>#}
{#                    <div class="modal-card-footer">#}
{#                        <button type="submit" class="btn btn-warning tableBtn" >送出</button>#}
{#                        <button type="button" class="btn btn-tumblr tableBtn" data-dismiss="modal">關閉</button>#}
{#                    </div>#}
{#                </form>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{#    <div class="modal fade" id="UserDetailModal" tabindex="-1" role="dialog" aria-labelledby="ModalCenterTitle"#}
{#            aria-hidden="true">#}
{#            <div class="modal-dialog modal-dialog-centered" role="document">#}
{#                <div class="modal-content">#}
{#                    <div class="modal-header">#}
{#                        <label class="modal-title text-template" id="exampleModalLabel">使用者資訊</label>#}
{#                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">#}
{#                            <span aria-hidden="true">&times;</span>#}
{#                        </button>#}
{#                    </div>#}
{#                    <div class="modal-body">#}
{#                        <div class="row">#}
{#                            <div class="col-md-3">&nbsp;</div>#}
{#                            <div class="col-md-12">#}
{#                            </div>#}
{#                            <div class="col-md-3">&nbsp;</div>#}
{#                        </div>#}
{#                    </div>#}
{#                    <div class="modal-footer">#}
{#                        <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
    <!-- * DialogIconedInfo -->
{% endblock %}

{% block js %}
    <script>
        function mobile_table_click(pub_id){
            var update_url = '{% url 'user_detail' '1___' %}';
            location.href=update_url.replace('1___', pub_id);
        }
        function reset_frm() {
            {#$('#user_first_name').val('');#}
            $('#created_at_min').val('');
            $('#created_at_max').val('');
            $("#user_first_name")[0].selectedIndex = 0;
            $("#user_first_name").selectpicker('refresh');
            $("#user_account")[0].selectedIndex = 0;
            $("#user_account").selectpicker('refresh');
            $("#company_name")[0].selectedIndex = 0;
            $("#company_name").selectpicker('refresh');
            $("#department_name")[0].selectedIndex = 0;
            $("#department_name").selectpicker('refresh');
            $("#user_role")[0].selectedIndex = 0;
            $("#user_role").selectpicker('refresh');
        }
        function resize_list_num(){
            var per_page_num = $('#per_page_num_sel').val();
            $('#per_page_num').val(per_page_num);
            var api_url = '{% url "user_management" %}';
            api_url += '?per_page_num=' + per_page_num;
            if ($('#user_first_name').val() != ''){
                api_url += '&user_first_name=' + $('#user_first_name').val();
            }
            if ($('#user_account').val() != ''){
                api_url += '&user_account=' + $('#user_account').val();
            }
            if ($('#company_name').val() != ''){
                api_url += '&company_name=' + $('#company_name').val();
            }
            if ($('#department_name').val() != ''){
                api_url += '&department_name=' + $('#department_name').val();
            }
            if ($('#user_role').val() != ''){
                api_url += '&user_role=' + $('#user_role').val();
            }
            if ($('#created_at_min').val() != ''){
                api_url += '&created_at_min=' + $('#created_at_min').val();
            }
            if ($('#created_at_max').val() != ''){
                api_url += '&created_at_max=' + $('#created_at_max').val();
            }
            location.href=api_url;
        }
        function company_select(){
            var dp_dict = {{ department_dict|safe }};
            var dp_list = dp_dict[$('#company_name :selected').text()];
            $('#department_name option').remove();
            $('#department_name').append(new Option('無', '', false, false));
            for (var i in dp_list){
                $('#department_name').append(new Option(dp_list[i], dp_list[i], false, false));
            }
            $("#department_name").selectpicker("refresh");
        }
        function update_user_manage(user_id, company_id, staff_id, edit_flag, backpage, manage_type){
            var api_url = '{% url 'edit_user_manage_enable' '1___' '2___' '3___' '4___' '5___' '6___' %}';
            api_url = api_url.replace('1___', user_id);
            api_url = api_url.replace('2___', company_id);
            api_url = api_url.replace('3___', staff_id);
            api_url = api_url.replace('4___', edit_flag);
            api_url = api_url.replace('5___', backpage);
            api_url = api_url.replace('6___', manage_type);

            api_url = api_url + '?page=' + '{{ request.GET.page }}';
            api_url = api_url + '&per_page_num=' + '{{ request.GET.per_page_num }}';
            api_url = api_url + '&user_first_name=' + '{{ request.GET.user_first_name }}';
            api_url = api_url + '&user_account=' + '{{ request.GET.user_account }}';
            api_url = api_url + '&user_role=' + '{{ request.GET.user_role }}';
            api_url = api_url + '&company_name=' + '{{ request.GET.company_name }}';
            api_url = api_url + '&department_name=' + '{{ request.GET.department_name }}';
            api_url = api_url + '&created_at_min=' + '{{ request.GET.created_at_min }}';
            api_url = api_url + '&created_at_max=' + '{{ request.GET.created_at_max }}';

            location.href = api_url;
        }


        $(document).ready(function() {
            $('#datetimepicker_min').datetimepicker({
                format: 'YYYY-MM-DD HH:mm',
                locale: 'zh-cn'
            });
            $('#datetimepicker_max').datetimepicker({
                format: 'YYYY-MM-DD HH:mm',
                locale: 'zh-cn',
                useCurrent: false
            });
            $("#datetimepicker_min").on("dp.change", function (e) {
                $('#datetimepicker_max').data("DateTimePicker").minDate(e.date);
            });
            $("#datetimepicker_max").on("dp.change", function (e) {
                $('#datetimepicker_min').data("DateTimePicker").maxDate(e.date);
            });
            var department_sel = '{{ request.GET.department_name }}';
            $('#department_name option').remove();
            $('#department_name').append(new Option('無', '', false, false));
            if ($('#company_name').val() != ''){
                var dp_dict = {{ department_dict|safe }};
                var dp_list = dp_dict[$('#company_name :selected').text()];
                for (var i in dp_list){
                    if (department_sel == dp_list[i]){
                        $('#department_name').append(new Option(dp_list[i], dp_list[i], true, true));
                    }else{
                        $('#department_name').append(new Option(dp_list[i], dp_list[i], false, false));
                    }
                }
                $("#department_name").selectpicker("refresh");
            }

        });
    </script>
{% endblock %}
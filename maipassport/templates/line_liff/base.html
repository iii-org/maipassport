{% load static %}
{% load i18n %}
<!doctype html>
<html lang="en" class="deeppurple-theme">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover, user-scalable=no">
    <meta name="description" content="">
    <meta name="author" content="Maxartkiller">

    <title></title>

    <!-- Material design icons CSS -->
    <link rel="stylesheet" href="{% static 'app_web/vendor/materializeicon/material-icons.css' %}">

    <!-- Roboto fonts CSS -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">

    <!-- Bootstrap core CSS -->
    <link href="{% static 'app_web/vendor/bootstrap-4.4.1/css/bootstrap.min.css' %}" rel="stylesheet">

    <!-- Swiper CSS -->
    <link href="{% static 'app_web/vendor/swiper/css/swiper.min.css' %}" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="{% static 'app_web/css/style.css' %}" rel="stylesheet">
    <style>
        .row {
            margin-right: 1px;
        }

        .crop img {
            width: 80px;
            height: 100px;
            margin: -25px 0 0 -10px;
        }

        {# 深色模式 logo #}
        .theme-dark .header-logo {
            /*content: url('../img/logo-header-white.png');*/
            {#content: url({% static 'app_web/img/logo-04a.png' %});#}
            {% if request.session.iii_login %}
                content: url({% static 'app_web/img/main_logo_white.png' %});
            {% else %}
                content: url({% static 'app_web/img/logo-04a.png' %});
            {% endif %}
        }

        .theme-dark .logo-small {
            /*content: url('../img/logo-login-white.png');*/
            {% if request.session.iii_login %}
                content: url({% static 'app_web/img/main_logo_white.png' %});
            {% else %}
                content: url({% static 'app_web/img/logo-04a.png' %});
            {% endif %}
        }
        .logo-small {
            /*content: url('../img/logo-login-white.png');*/
            {% if not request.session.iii_login %}
                width: 250px;
            {% endif %}
        }
        {#.ix_bar{}#}
    </style>
    {% block stylesheet %}{% endblock %}
    <style>
        /* iPhone X and Xs Max */
        @media only screen
            and (min-device-width: 375px)
            and (min-device-height: 812px)
            and (-webkit-device-pixel-ratio: 3)
            and (orientation: portrait) {
                /* styles */

                .header {
                    height: env(safe-area-inset-top);
                    padding: env(safe-area-inset-top);
                }

                .contentinfo{
                    /*padding: 44px 3% 0 3%;*/
                    padding: env(safe-area-inset-top) 3% 0 3%;
                }
                .ix_bar{
                    height: 30px;
                }
                .header .btn {
                    text-align: left;
                    width: 30px;
                }
            }

        /* iPhone XR */
        @media only screen
            and (min-device-width: 414px)
            and (min-device-height: 896px)
            and (-webkit-device-pixel-ratio: 2)
            and (orientation: portrait) {
                /* styles */

                .header {
                    height: env(safe-area-inset-top);
                    padding: env(safe-area-inset-top);
                }

                .contentinfo{
                    padding: env(safe-area-inset-top) 3% 0 3%;
                }
                .ix_bar{
                    height: 30px;
                }
                .header .btn {
                    text-align: left;
                    width: 30px;
                }
            }
    </style>
</head>
<body>
<!-- Loader -->
<div class="row no-gutters vh-100 bg-template loader-screen " id="loader_page">
    <div class="col align-self-center text-center">
        {#            <img src="{% static 'app_web/img/main_logo_white.png' %}" alt="logo" class="logo-small">#}
        {#            <img src="{% static 'app_web/img/logo-04a.png' %}" alt="logo" class="logo-small">#}
        {% if request.session.iii_login %}
            <img src="{% static 'app_web/img/main_logo_white.png' %}" alt="logo" class="logo-small">
        {% else %}
            <img src="{% static 'app_web/img/logo-04a.png' %}" alt="logo" class="logo-small">
        {% endif %}
        {#            <h1 class="mt-3"><span class="font-weight-light ">我的</span>通行碼</h1>#}
        <h1 class="mt-3">{% trans 'MY PASSCODE' %}</h1>

        <div class="laoderhorizontal">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
</div>
    <!-- Loader ends -->

<div class="wrapper" id="wrapper_base">
    <div class="row" id="header_bar" style="padding-top: 5px;">
        <div class="col text-center">
            {% if request.session.iii_login %}
                <img src="{% static 'app_web/img/main_logo.png' %}" alt="" class="header-logo" style="margin-left: -15px;">
            {% else %}
                <img src="{% static 'app_web/img/logo-04b.png' %}" alt="" class="header-logo" style="width: 190px;max-height: 65px;">
            {% endif %}
        </div>
    </div>
    {% block content %}
    {% endblock %}
</div>
<!-- message modal -->
<div class="modal fade" id="message_modal" tabindex="-1" role="dialog" aria-labelledby="ModalCenterTitle"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title text-template" id="exampleModalLabel">{% trans 'Message' %}</h6>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="msg" class="text-template"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans 'Close' %}</button>
            </div>
        </div>
    </div>
</div>
{#<div class="modal fade" id="declaration_finish_modal" tabindex="-1" role="dialog" aria-labelledby="ModalCenterTitle"#}
{#     aria-hidden="true">#}
{#    <div class="modal-dialog modal-dialog-centered" role="document">#}
{#        <div class="modal-content">#}
{#            <div class="modal-header">#}
{#                <h6 class="modal-title text-template" id="exampleModalLabel">{% trans 'Message' %}</h6>#}
{#                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="liff.closeWindow();">#}
{#                    <span aria-hidden="true">&times;</span>#}
{#                </button>#}
{#            </div>#}
{#            <div class="modal-body">#}
{#                <p class="text-template">{% trans 'Complete the declaration' %}</p>#}
{#            </div>#}
{#            <div class="modal-footer">#}
{#                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="liff.closeWindow();">{% trans 'Close' %}</button>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{#</div>#}
<!-- model end -->
<script src="{% static 'app_web/js/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'app_web/js/popper.min.js' %}"></script>
<script src="{% static 'app_web/vendor/bootstrap-4.4.1/js/bootstrap.min.js' %}"></script>

<!-- swiper js -->
<script src="{% static 'app_web/vendor/swiper/js/swiper.min.js' %}"></script>

<!-- cookie js -->
<script src="{% static 'app_web/vendor/cookie/jquery.cookie.js' %}"></script>

<!-- template custom js -->
<script src="{% static 'app_web/js/main.js' %}"></script>
<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script>
    function getLocation(){
        var latitude;
        var longitude;
        if (navigator.geolocation) {
            var geo=navigator.geolocation;
            var option={
                enableAcuracy:false,
                maximumAge:0,
                timeout:600000
            };
            geo.getCurrentPosition(successCallback,
                errorCallback,
                option
            );
        }
        else {
            {#alert("此瀏覽器不支援地理定位功能!");#}
            {#if ('{{ request.app_user }}'){#}
            {#    location.href = "{% url 'app_logout' %}"}#}
            {#$("#msg").text("{% trans 'This browser does not support geolocation!' %}");#}
            {#$("#message_modal").modal();#}
        }
        function successCallback(position) {
            latitude = position.coords.latitude;
            longitude = position.coords.longitude;
            {#document.getElementById('latitude').value = latitude;#}
            {#document.getElementById('longitude').value = longitude;#}
            $('#latitude').val(latitude);
            $('#longitude').val(longitude);
        }
        function errorCallback(error) {
            var errorTypes={
                0:"不明原因錯誤",
                1:"使用者拒絕提供位置資訊",
                2:"無法取得位置資訊",
                3:"位置查詢逾時"
            };
            {#alert(errorTypes[error.code]);#}
            //alert(error.message);  //測試時用
            {#if ('{{ request.app_user }}'){#}
            {#    location.href = "{% url 'app_logout' %}"}#}
            {#$("#msg").text("取得地址錯誤：" + errorTypes[error.code]);#}
            {#$("#message_modal").modal();#}
        }
    }
    function initializeLiff(myLiffId, redirectUrl) {
        liff.init({
            liffId: myLiffId
        })
            .then(() => {
                if (!liff.isLoggedIn()) {
                    liff.login({ redirectUri: redirectUrl });
                }
            })
            .catch((err) => {
            });
    }

    function default_img() {
        if (document.getElementById('side_bar_user_img') != undefined){
            document.getElementById('side_bar_user_img').src = '{% static 'app_web/img/avatar_def.png' %}';
            document.getElementById('side_bar_user_img_div').setAttribute('class', 'col-auto');
        }
        if (document.getElementById('user_img') != undefined){
            document.getElementById('user_img').src = '{% static 'app_web/img/avatar_def.png' %}';
            document.getElementById('user_img_div').setAttribute('class', 'col-auto');
        }
        if (document.getElementById('profile_user_img') != undefined){
            document.getElementById('profile_user_img').src = '{% static 'app_web/img/avatar_def.png' %}';
            document.getElementById('profile_user_img_div').setAttribute('class', 'figure-profile shadow my-4');

        }
    }

    function set_img(img_str) {
        if (img_str == null || img_str == undefined || img_str == ''){
            default_img();
            sessionStorage.removeItem("user_image_storage");
        }else{
            if (document.getElementById('side_bar_user_img') != undefined){
                document.getElementById('side_bar_user_img').src = img_str;
                document.getElementById('side_bar_user_img_div').setAttribute('class', 'col-auto crop');
            }
            if (document.getElementById('user_img') != undefined){
                {#setUserImgMargin(document.getElementById('user_img'));#}

                document.getElementById('user_img').src = img_str;
                document.getElementById('user_img_div').setAttribute('class', 'col-auto crop');
            }
            if (document.getElementById('profile_user_img') != undefined){

                document.getElementById('profile_user_img').src = img_str;
                document.getElementById('profile_user_img_div').setAttribute('class', 'figure-profile shadow my-4');
                document.getElementById('profile_user_img').onload = function () {
                    var img_height = document.getElementById('profile_user_img').height;
                    var img_width = document.getElementById('profile_user_img').width;
                    var h_scale = 0;
                    var w_scale = 0;

                    if (img_height != img_width){
                        var h_digt = img_height - 158;
                        if (h_digt > 0){
                            h_scale = (h_digt / 2) * -1;
                        }
                        var w_digt = img_width - 158;
                        if (w_digt > 0){
                            w_scale = (w_digt / 2) * -1;
                        }
                    }
                    document.getElementById('profile_user_img').style.margin = "" + h_scale + "px " + w_scale + "px " +  h_scale + "px " + w_scale + "px ";
                };
            }
        }
    }

    function get_user_image(source_from){
        var login_account = '{{ request.user.username }}';
        var user_image_storage = sessionStorage.getItem("user_image_storage");
        {#var user_image_source = sessionStorage.getItem("user_image_source");#}
        if (user_image_storage == null || user_image_storage == undefined || user_image_storage == ''){
            default_img();
            sessionStorage.removeItem("user_image_storage");
        }else{

            if (sessionStorage.getItem("user_account") == login_account){
                set_img(user_image_storage);
            }else{
                default_img();
                sessionStorage.removeItem("user_image_storage");
            }
        }
        var server_url;
        if (window.location.port == '8003'){
            server_url = 'http://' + window.location.hostname +':' + window.location.port;
        }else{
            server_url = window.location.protocol + '//' + window.location.host + window.location.port;
        }
        server_url = server_url + '/get_user_img/' + source_from + '/';
        $.ajax({
            type: 'get',
            url: server_url,
            data: {"uts": new Date().getTime()},
            headers: {
                'Content-Type': 'application/json',
                {#'Accept': 'application/vnd.ani.v1.wallet+json',#}
                'X-MAI-TOKEN': 'WebUser ' + '{{ request.app_user.api_token }}',
                {#'X-Client-Version': '1.0',#}
                'X-Client-Id': '{{ request.app_user.pub_id }}',
            },
            success: function(response) {
                $.each(response, function(index, value) {
                    {#if (value != user_image_storage){#}
                    {#    sessionStorage.setItem("user_image_storage", value);#}
                    {#    sessionStorage.setItem("user_account", login_account);#}
                    {#    if (value == null){#}
                    {#        sessionStorage.removeItem("user_image_storage");#}
                    {#        default_img();#}
                    {#    }else{#}
                    {#        set_img(value);#}
                    {#    }#}
                    {# }#}
                    var obj = JSON.parse(value);


                    if (obj.img_data != user_image_storage){

                        sessionStorage.removeItem("user_image_storage");
                        sessionStorage.setItem("user_image_storage", obj.img_data);
                        sessionStorage.setItem("user_account", login_account);
                        sessionStorage.setItem('user_image_width', obj.img_width);
                        sessionStorage.setItem('user_image_height', obj.img_height);

                        if (obj.img_data == null){
                            sessionStorage.removeItem("user_image_storage");
                            default_img();
                        }else{
                            set_img(obj.img_data);
                        }
                    }
                });
            },
            error: function(xhr, status, error) {
                default_img();
                sessionStorage.removeItem("user_image_storage");
            }
        });
    }

    $(document).ready(function(){
        var redirectUrl = "https://" + "{{ LIFF_REDIRECT_URL }}" + "/line/router/";
        redirectUrl = redirectUrl + '?func_type=' + '{{ request.session.func_type }}' + '&language=' + '{{ request.COOKIES.language }}';
        {#initializeLiff('{{ request.session.LIFF_ID }}', redirectUrl);#}
        getLocation();
        get_user_image('default');
        if ('{{ message }}'){
            $("#msg").text('{{ message }}');
            $("#message_modal").modal();
        }
    });




</script>
{% block js %}
{% endblock %}

</body>

</html>
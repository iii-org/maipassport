{% extends 'app_web_n/base.html' %}
{% load static %}
{% load i18n %}
{% block stylesheet %}
    <style>
    </style>
{% endblock %}
{% block content %}

    <div class="wrapper" id="wrapper_base">
{#        <div class="row" id="header_bar" style="padding-top: 5px;">#}
{#            <div class="col text-center">#}
{#                {% if request.session.iii_login %}#}
{#                    <a href="{% url 'app_index' request.app_user.pub_id request.app_user.api_token %}">#}
{#                        <img src="{% static 'app_web/img/main_logo.png' %}" alt="" class="header-logo" style="margin-left: -15px;">#}
{#                    </a>#}
{#                {% else %}#}
{#                    <a href="{% url 'app_index' request.app_user.pub_id request.app_user.api_token %}">#}
{#                        <img src="{% static 'app_web/img/logo-04b.png' %}" alt="" class="header-logo" style="width: 190px;max-height: 65px;">#}
{#                    </a>#}
{#                {% endif %}#}
{#            </div>#}
{#        </div>#}
        <div style="height: 50px;"></div>
        <div class="row">
            <div class="container">
                <div class="row" style="padding-left: 30px;">
                    <div class="col-12" style="padding-left: 0;padding-right: 0;">
                        <div class="card shadow-sm border-0 mb-3 wizard">
                            <div class="card-header p-0">
                                <ul class="nav nav-tabs tabs-md nav-justified" role="tablist">
                                    <li role="presentation" class="nav-item">
                                        <a href="#step13" class="nav-link border-primary active" data-toggle="tab" aria-controls="step13" role="tab" title="Step 1" id="step13_a">
    {#                                        <i class="material-icons">assignment</i>#}
                                            {% trans 'Shop Registration' %}
                                        </a>
                                    </li>
                                    <li role="presentation" class="nav-item">
                                        <a href="#step23" class="nav-link border-primary" data-toggle="tab" aria-controls="step23" role="tab" title="Step 2" id="step23_a">
    {#                                        <i class="material-icons">assignment_turned_in</i>#}
                                            {% trans 'Location List' %}
                                        </a>
                                    </li>
                                </ul>
                            </div>
    {#                        <a onclick="approach_record()"></a>#}
                            <div class="card-body">
                                <div class="tab-content">
                                    <div class="tab-pane active" role="tabpanel" id="step13">
    {#                                    <h6 class="subtitle" style="padding-left: 15px;">{% trans 'Company / School Registration' %}</h6>#}
                                        <div class="col-12 px-0">
                                            <div style="height: 30px;"></div>
                                            <div id="step1_a_div" class="text-center">
                                                <form method="post" action="{% url 'shop_qrcode' request.app_user.pub_id request.app_user.api_token %}">
                                                {% csrf_token %}
                                                    <div class="row bottom40">
                                                        <div class="col-md-12 col-sm-12 col-xs-12">
                                                            <div class="form-group float-label active" >
                                                                <input type="text" class="form-control text-template" id="id_username" name="app_user" style="font-size: 18px;" value="{{ applicant.auth_user.first_name }}">
                                                                <label class="form-control-label " style="font-size: 18px;">{% trans 'Applicant' %}</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row bottom40">
                                                        <div class="col-md-12 col-sm-12 col-xs-12">
                                                            <div class="form-group float-label active" >
                                                                <input type="text" class="form-control text-template" style="font-size: 18px;" value="{{ applicant.auth_user.username }}">
                                                                <label class="form-control-label " style="font-size: 18px;">{% trans 'Applicant Phone' %}</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row bottom40">
                                                        <div class="col-md-12 col-sm-12 col-xs-12">
                                                            <div class="form-group float-label active" >
                                                                <input type="text" class="form-control text-template" name="shop_name" style="font-size: 18px;" >
                                                                <label class="form-control-label " style="font-size: 18px;">{% trans 'Shop / Location Name' %}</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row bottom40">
                                                        <div class="col-md-12 col-sm-12 col-xs-12">
                                                            <div class="form-group float-label active" >
                                                                <input type="text" class="form-control text-template" name="shop_address" style="font-size: 18px;" >
                                                                <label class="form-control-label " style="font-size: 18px;">{% trans 'Shop / Location Address' %}</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row bottom40">
                                                        <div class="col-md-12 col-sm-12 col-xs-12">
                                                            <div class="form-group float-label active" >
                                                                <input type="text" class="form-control text-template" name="shop_phone" style="font-size: 18px;" >
                                                                <label class="form-control-label " style="font-size: 18px;">{% trans 'Shop / Location Phone' %}</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row bottom40">
                                                        <div class="col-md-12 col-sm-12 col-xs-12">
                                                            <div class="form-group float-label active">
                                                                <input type="text" class="form-control text-template" name="register_code" style="font-size: 18px;">
                                                                <label class="form-control-label" style="font-size: 18px;">{% trans 'Register Code' %}</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div style="height: 50px;"></div>
                                                    <div class="row bottom40">
                                                        <div class="col-md-12 col-sm-12 col-xs-12">
                                                            <button type="submit" class="btn btn-lg btn-default text-white btn-block btn-rounded shadow" id="btn_send"><span>{% trans 'Submit' %}</span></button>
                                                        </div>
                                                    </div>
                                                    <div style="height: 20px;"></div>
                                                    <div class="row bottom40">
                                                        <div class="col-md-12 col-sm-12 col-xs-12">
    {#                                                        <a onclick="liff.closeWindow()"  class="btn btn-lg btn-default text-white btn-block btn-rounded shadow" style="background-color: #848181;"><span>{% trans 'Back' %}</span></a>#}
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane" role="tabpanel" id="step23">
    {#                                    <h6 class="subtitle" style="padding-left: 15px;">{% trans 'Registration List' %}</h6>#}
                                        <div class="col-12 px-0">
                                            <ul class="list-group list-group-flush border-top border-bottom" id="step2_div">
    {#                                            <li style="list-style: none">#}
    {#                                                <div class="wrapper" id="wrapper_base">#}
    {#                                                    <div class="col-md-8 col-sm-8 col-xs-8" style="text-align: left; float: left; font-size: 18px">shop_name</div>#}
    {#                                                    <div class="col-md-4 col-sm-4 col-xs-4" style="float:right">#}
    {#                                                        <button class="btn btn-danger" style="float: right">Qrcode</button>#}
    {#                                                    </div>#}
    {#                                                    <div class="col-md-8 col-sm-8 col-xs-8" style="text-align: left; float: left; font-size: 18px">Company_name</div>#}
    {#                                                    <div class="col-md-4 col-sm-4 col-xs-4" style="float:right">#}
    {#                                                        <button class="btn btn-default" style="float: right">Modify</button>#}
    {#                                                    </div>#}
    {#                                                    <div class="col-md-8 col-sm-8 col-xs-8" style="font-size: 18px; float: left">timestamp</div>#}
    {#                                                <div class="clearfix"></div>#}
    {#                                                </div>#}
                                                </li>
                                            </ul>
                                            <div style="height: 30px;"></div>
                                            <div id="step2_a_div" class="text-center"></div>
                                            <div class="text-center">
                                                <div style="height: 20px;"></div>
                                                <div class="row bottom40">
                                                    <div class="col-md-12 col-sm-12 col-xs-12">
    {#                                                    <a onclick="liff.closeWindow()"  class="btn btn-lg btn-default text-white btn-block btn-rounded shadow" style="background-color: #848181;"><span>{% trans 'Back' %}</span></a>#}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="clearfix"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- message modal -->
    <div class="modal fade" id="message_modal" tabindex="-1" role="dialog" aria-labelledby="ModalCenterTitle"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title text-template" id="exampleModalLabel">{% trans 'Message' %}</h6>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="msg" class="text-template"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans 'Close' %}</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="cancel_apply_modal" tabindex="-1" role="dialog" aria-labelledby="ModalCenterTitle"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h6 class="modal-title text-template" id="exampleModalLabel">{% trans 'Message' %}</h6>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" >
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="text-template">{% trans 'Are you sure you want to cancel?' %}</p>
                </div>
                <div class="modal-footer">
                    <form method="post" action="{% url 'shop_qrcode_cancel' request.app_user.pub_id request.app_user.api_token %}">
                        {% csrf_token %}
                        <input type="hidden" name="apply_id" id="apply_id">
                        <button type="submit" class="btn btn-danger" >{% trans 'Submit' %}</button>
                        &nbsp;
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans 'Close' %}</button>
                    </form>
                </div>

            </div>
        </div>
    </div>
    <div class="modal fade" id="qr_img_modal" tabindex="-1" role="dialog" aria-labelledby="ModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <label class="modal-title text-template" id="exampleModalLabel">{% trans 'Location Qrcode' %}</label>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" >
                    <div class="row">
                        <div class="col text-center">
                            <label id="qr_info" style="font-size: 20px;" ></label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col text-center">
                            <img id="qr_image" height="80%" width="80%" alt="">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans 'close' %}</button>
                </div>
            </div>
        </div>
    </div>
{#    <!-- model end -->#}
{#    <script src="{% static 'app_web/js/jquery-3.6.0.min.js' %}"></script>#}
{#    <script src="{% static 'app_web/js/popper.min.js' %}"></script>#}
{#    <script src="{% static 'app_web/vendor/bootstrap-4.4.1/js/bootstrap.min.js' %}"></script>#}
{##}
{#    <!-- swiper js -->#}
{#    <script src="{% static 'app_web/vendor/swiper/js/swiper.min.js' %}"></script>#}
{##}
{#    <!-- cookie js -->#}
{#    <script src="{% static 'app_web/vendor/cookie/jquery.cookie.js' %}"></script>#}
{##}
{#    <!-- template custom js -->#}
{#    <script src="{% static 'app_web/js/main.js' %}"></script>#}
{#    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>#}
{% endblock %}

{% block js %}
    <!-- cookie js -->
    <script src="{% static 'app_web/vendor/cookie/jquery.cookie.js' %}"></script>

    <!-- chart js -->
    <script src="{% static 'app_web/vendor/chartjs/Chart.min.js' %}"></script>
    <script src="{% static 'app_web/vendor/chartjs/utils.js' %}"></script>

     <!-- page level custom js -->
    <script>
        var server_url;
        function edit_place_open(place_id){
            var url = '{% url 'shop_qrcode_edit' request.app_user.pub_id request.app_user.api_token %}';
            url += '?place_id=' + place_id;
            location.href = url;
        }
        function shop_reg_record(next_url){
                var record_list, next_link, api_url, html_str;
                {#var sJson = JSON.stringify({record_type: 'APPROACH', uts: new Date().getTime(),});#}
                if (next_url == 'default'){
                    {#if (window.location.port == '8003'){#}
                    {#    api_url = 'http://' + window.location.hostname +':' + window.location.port + '/web-user-records/';#}
                    {# }else{#}
                    {#    api_url = window.location.protocol + '//' + window.location.host + '/web-user-records/';}#}
                    api_url = server_url + '/web-user-records/';
                }else{
                    api_url = next_url;
                }
                {#alert(api_url);#}
            {#console.log('url = '+ api_url);#}
                $.ajax({
                    type: 'get',
                    url: api_url,
                    data: {"record_type": 'SHOP_REG', "uts": new Date().getTime()},
                    headers: {
                        'Content-Type': 'application/json',
                        {#'Accept': 'application/vnd.ani.v1.wallet+json',#}
                        'X-MAI-TOKEN': 'WebUser ' + '{{ request.app_user.api_token }}',
                        {#'X-Client-Version': '1.0',#}
                        'X-Client-Id': '{{ request.app_user.pub_id }}',
                    },
                    success: function(response) {
                        {#alert(response);#}
                        $.each(response, function(index, value) {
                            if (index == 'results'){
                                record_list = value;
                                if (value == ''){
                                    document.getElementById('step2_div').style.display = "none";
                                    document.getElementById('step2_a_div').style.display = "";
                                    document.getElementById('step2_a_div').innerHTML = '{% trans 'No Application' %}';
                                }
                            }
                            if (index == 'next'){
                                if (value != null){
                                    value = value.replace('http://web', server_url);
                                    document.getElementById('step2_a_div').style.display = "";
                                    document.getElementById('step2_a_div').innerHTML = '<a onclick="shop_reg_record(\'' + value +  '\')">' + "{% trans 'More'  %}" + '</a>';
                                }else{
                                    document.getElementById('step2_a_div').style.display = "none";
                                }

                            }
                        });

                        for (var i in record_list){
                            html_str = '';
                            html_str += '<li class="list-group-item"><div class="row align-items-center"><div class="col align-self-center pr-0"><h6 class="font-weight-normal mb-1">' +
                                record_list[i]['shop_name'] + ' / ' + record_list[i]['shop_phone'] + '</h6><h6 class="font-weight-normal mb-1">' +
                                record_list[i]['shop_address']['location_address'] + '</h6><p class="text-mute small text-secondary">' + record_list[i]['record_time'] + '</p></div><div class="col-auto">';

                            if (record_list[i]['status'] == '0'){
                                html_str += '<h6 class="font-weight-normal mb-1 text-right" style="color: orangered">' + record_list[i]['status_show'] + '</h6>';
                                html_str += '<a onclick="cancel_apply(\''+ record_list[i]['pub_id']  + '\')" data-toggle="modal" data-target="#cancel_apply_modal" style="cursor: pointer; float: right;">'+ '{% trans "Cancel Apply" %}' +'</a>'
                            }else if(record_list[i]['status'] == '1') {
                                html_str += '<h6 class="text-success text-right">' + record_list[i]['status_show'] + '</h6>';
                                html_str += '<a onclick="get_qr_img(\'' + record_list[i]['pub_id'] + '\')" data-toggle="modal" data-target="#qr_img_modal" style="cursor: pointer; float: right;">' + '{% trans "Show Qrcode" %}' + '</a><br>';
                                {#html_str += '<h6>' + record_list[i]['pub_id'] + '</h6>'#}
                                html_str += '<a onclick="edit_place_open(\'' + record_list[i]['pub_id'] + '\')" style="cursor: pointer; float: right;">' + '{% trans "Edit" %}' + '</a>';
                            }else{
                                html_str += '<h6 class="text-danger text-right">' + record_list[i]['status_show'] + '</h6>';
                            }
                            html_str += '</div></div></li>';
                            document.getElementById('step2_div').innerHTML += html_str;
                            {#console.log('html_str = ' + html_str);#}
                        }

                    },
                    error: function(xhr, status, error) {

                        {#alert(xhr.responseText);#}
                        {#var error_result = JSON.parse(xhr.responseText);#}
                        {#alert(error_result[1]);#}
                        {#alert(typeof(error_result.errors.phone[0].code));#}
                        {#alert(error_result.errors.phone[0].message);#}


                    }
                });
            }
        function cancel_apply(apply_id){
            $('#apply_id').val(apply_id);
        }
        function get_qr_img(place_id){
                $('#qr_info').html('PLACE__' + place_id);
                var qr_url = "{% url 'qr_code' 'black' 'QRDATA' %}";
                qr_url = qr_url.replace('QRDATA', 'PLACE__' + place_id);
                {#alert(qr_url);#}
                document.getElementById('qr_image').setAttribute("src", qr_url);
                {#document.getElementById('qr_image').setAttribute("alt", 'PLACE__' + place_id);#}
        }
        {#function initializeLiff(myLiffId, redirectUrl) {#}
        {#    liff.init({#}
        {#        liffId: myLiffId#}
        {#    })#}
        {#        .then(() => {#}
        {#            if (!liff.isLoggedIn()) {#}
        {#                liff.login({ redirectUri: redirectUrl });#}
        {#            }#}
        {#        })#}
        {#        .catch((err) => {#}
        {#        });#}
        {# }#}

        $(document).ready(function(){
            if (window.location.port == '8000' || window.location.port == '8003'){
                server_url = 'http://' + window.location.hostname +':' + window.location.port;
            }else{
                server_url = window.location.protocol + '//' + window.location.host + window.location.port;
            }
            {#console.log('server_url = ' + server_url);#}
            shop_reg_record('default');
            document.getElementsByTagName("title")[0].innerText = '{% trans "Shop Code" %}' + ' Â· ' + '{% trans "My PassCode" %}';
            document.getElementById('backpage').style.display = "none";
            document.getElementById('sidebar').style.display = "";
            document.getElementById('hamburger').style.display = "";
            if ('{{ show_list }}' != ''){
                $("#step13").removeClass('active');
                document.getElementById("step23").setAttribute("class", "tab-pane active")

                $("#step13_a").removeClass('active');
                document.getElementById("step23_a").setAttribute("class", "nav-link border-primary active")
            }


            if ('{{ message }}'){
                $("#msg").text('{{ message }}');
                $("#message_modal").modal();
            }
         });




    </script>
{% endblock %}